{% extends "base.html" %}
{% block title %}Agregar producto{% endblock %}
{% block page_styles %}
<style>
    .container { max-width: 700px; margin-top: 50px; background-color: #333; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
    .form-control { border-radius: 10px; padding: 8px; }
    select { background-color: #333; color: white; border: 1px solid #777; }
    select option { background-color: #222; color: white; }
    select option:hover { background-color: #444; }
</style>
{% endblock %}

    {% block content %}
    <main class="container p-5">
    <a href="{{ url_for('inventario.productos') }}" class="back-btn material-symbols-outlined" style="position: absolute; top: 40px; left: 70px;" aria-label="Volver al inventario">
        arrow_back
    </a>
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2 class="text-center titlewhiteN mb-4">Introduzca los datos del producto</h2>
            <form action="/agregar-producto" method="post">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    <label class="titlewhite" for="proveedor_id">Proveedor</label>
                    <select class="form-control fondo titlewhite" id="proveedor" name="proveedor_id">
                        <option value="">Seleccione un proveedor</option>
                        {% for proveedor in proveedores %}
                            <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="cif">CIF de la Empresa:</label>
                    <input class="form-control fondo titlewhite" id="cif" type="text" readonly>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="tipo_producto">Tipo de Producto:</label>
                    <select class="form-control fondo titlewhite" id="tipo_producto" name="tipo_producto">
                        <option value="" disabled selected>Seleccione el tipo de producto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="marca">Marca:</label>
                    <select class="form-control fondo titlewhite" id="marca" name="marca" required>
                        <option value="" disabled selected>Seleccione la Marca</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="modelo">Modelo:</label>
                    <select class="form-control fondo titlewhite" id="modelo" name="modelo">
                        <option value="" disabled selected>Seleccione el Modelo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="descripcion">Descripción</label>
                    <textarea id="descripcion" name="descripcion" class="form-control fondo titlewhite" placeholder="Descripción del producto" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="cantidad">Cantidad</label>
                    <input type="number" id="cantidad" name="cantidad" class="form-control fondo titlewhite" placeholder="Cantidad del producto" required>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="cantidad_minima">Cantidad mínima</label>
                    <input type="number" id="cantidad_minima" name="cantidad_minima" class="form-control fondo titlewhite" placeholder="Cantidad mínima requerida" required>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="precio">Precio</label>
                    <input type="number" id="precio" name="precio" step="0.01" class="form-control fondo titlewhite" placeholder="Precio del producto" required>
                </div>
                <div class="form-group">
                    <label class="titlewhite" for="num_referencia">Número de referencia</label>
                    <input autocomplete="off" type="text" id="num_referencia" name="num_referencia" class="form-control fondo titlewhite" placeholder="Número de referencia del producto" required>
                </div>
                <button class="btn-block neon-link titlewhite fondo" style="background-color: transparent; color: white;" type="submit">
                    Agregar producto
                </button>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const proveedorSelect = document.getElementById('proveedor');
                    const tiposProductoSelect = document.getElementById('tipo_producto');
                    const cifInput = document.getElementById('cif');

                    proveedorSelect.addEventListener('change', function () {
                        const proveedorId = this.value;
                        fetch(`/tipos-producto/${proveedorId}`)
                            .then(response => response.json())
                            .then(data => {
                                tiposProductoSelect.innerHTML = '';
                                if (data.tipos_producto) {
                                    data.tipos_producto.forEach(tipo => {
                                        const option = document.createElement('option');
                                        option.value = tipo;
                                        option.textContent = tipo;
                                        tiposProductoSelect.appendChild(option);
                                    });
                                }
                            });
                        fetch(`/proveedor/${proveedorId}`)
                            .then(response => response.json())
                            .then(data => {
                                cifInput.value = data.cif || '';
                            });
                    });
                });
            </script>
            <script>
                document.getElementById("proveedor").addEventListener("change", function () {
                    document.getElementById("marca").innerHTML = '<option value="" disabled selected>Seleccione la Marca</option>';
                    document.getElementById("modelo").innerHTML = '<option value="" disabled selected>Seleccione el Modelo</option>';
                });
            </script>
            <script>
                document.getElementById('tipo_producto').addEventListener('change', function() {
                    var tipoProducto = this.options[this.selectedIndex].text;
                    fetch(`/get_marcas?tipo_producto=${encodeURIComponent(tipoProducto)}`)
                        .then(response => response.json())
                        .then(data => {
                            var marcaSelect = document.getElementById('marca');
                            marcaSelect.innerHTML = '';
                            var defaultOption = document.createElement('option');
                            defaultOption.value = '';
                            defaultOption.text = 'Seleccionar Marca';
                            marcaSelect.appendChild(defaultOption);
                            data.forEach(function(marca) {
                                var option = document.createElement('option');
                                option.value = marca.nombre;
                                option.text = marca.nombre;
                                marcaSelect.appendChild(option);
                            });
                        });
                });
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const tipoProductoSelect = document.getElementById('tipo_producto');
                    const marcaSelect = document.getElementById('marca');
                    const modeloSelect = document.getElementById('modelo');
                    marcaSelect.addEventListener('change', function () {
                        const tipoProducto = tipoProductoSelect.value.trim();
                        const marca = this.value.trim();
                        modeloSelect.innerHTML = '';
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.text = 'Seleccionar Modelo';
                        modeloSelect.appendChild(defaultOption);
                        fetch(`/get_modelos?tipo_producto=${encodeURIComponent(tipoProducto)}&marca=${encodeURIComponent(marca)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.error) {
                                    alert(data.error);
                                    return;
                                }
                                data.forEach(function(modelo) {
                                    const option = document.createElement('option');
                                    option.value = modelo.modelo;
                                    option.text = modelo.modelo;
                                    modeloSelect.appendChild(option);
                                });
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Hubo un problema al obtener los modelos. Por favor, intenta nuevamente.');
                            });
                    });
                });
            </script>
        </div>
    </div>
</main>
{% endblock %}
