{% extends "base.html" %}
{% block title %}Agregar producto{% endblock %}

{% block content %}
<main class="container mx-auto my-8 px-4 flex justify-center pb-12">
    <div class="glass-panel w-full max-w-4xl p-8 relative animate-fade-in shadow-2xl shadow-primary-900/10">
        <!-- Back Button -->
        <a href="{{ url_for('inventario.productos') }}"
            class="absolute top-8 left-8 flex items-center justify-center w-10 h-10 rounded-full border border-canvas-700 text-canvas-400 hover:text-primary-400 hover:border-primary-400 transition-all bg-canvas-900/50"
            aria-label="Volver">
            <span class="material-symbols-outlined text-lg">arrow_back</span>
        </a>

        <div class="text-center mb-8 mt-4">
            <h2
                class="text-3xl font-bold font-heading italic text-transparent bg-clip-text bg-gradient-to-r from-primary-200 to-primary-400 mb-2">
                Nuevo Producto
            </h2>
            <p class="text-canvas-400 text-sm">Registre un nuevo artículo en el inventario.</p>
        </div>

        <form action="/agregar-producto" method="post" class="space-y-6">
            {{ form.hidden_tag() }}

            <!-- Proveedor Section -->
            <div class="bg-canvas-900/40 border border-canvas-700/50 rounded-xl p-6">
                <h3
                    class="text-sm font-bold text-primary-400 uppercase tracking-wider mb-4 border-b border-canvas-700/50 pb-2">
                    Información del Proveedor</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="proveedor" class="block text-sm font-medium text-canvas-300">Proveedor</label>
                        <select class="form-input focus:border-primary-500 focus:ring-primary-500" id="proveedor"
                            name="proveedor_id">
                            <option value="">Seleccione un proveedor</option>
                            {% for proveedor in proveedores %}
                            <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="cif" class="block text-sm font-medium text-canvas-300">CIF de la Empresa</label>
                        <input class="form-input bg-canvas-900/80 text-canvas-500 cursor-not-allowed border-canvas-700"
                            id="cif" type="text" readonly>
                    </div>
                </div>
            </div>

            <!-- Producto Info -->
            <div class="bg-canvas-900/40 border border-canvas-700/50 rounded-xl p-6">
                <h3
                    class="text-sm font-bold text-amber-400 uppercase tracking-wider mb-4 border-b border-canvas-700/50 pb-2">
                    Datos del Artículo</h3>

                <div class="space-y-4">
                    <div class="space-y-2">
                        <label for="tipo_producto" class="block text-sm font-medium text-canvas-300">Tipo de
                            Producto</label>
                        <select class="form-input focus:border-primary-500 focus:ring-primary-500" id="tipo_producto"
                            name="tipo_producto">
                            <option value="" disabled selected>Seleccione el tipo de producto</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="marca" class="block text-sm font-medium text-canvas-300">Marca</label>
                            <select class="form-input focus:border-primary-500 focus:ring-primary-500" id="marca"
                                name="marca" required>
                                <option value="" disabled selected>Seleccione la Marca</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="modelo" class="block text-sm font-medium text-canvas-300">Modelo</label>
                            <select class="form-input focus:border-primary-500 focus:ring-primary-500" id="modelo"
                                name="modelo">
                                <option value="" disabled selected>Seleccione el Modelo</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="descripcion" class="block text-sm font-medium text-canvas-300">Descripción</label>
                        <textarea id="descripcion" name="descripcion"
                            class="form-input focus:border-primary-500 focus:ring-primary-500" rows="3"
                            placeholder="Detalles técnicos y características..." required></textarea>
                    </div>
                </div>
            </div>

            <!-- Inventario y Precios -->
            <div class="bg-canvas-900/40 border border-canvas-700/50 rounded-xl p-6">
                <h3
                    class="text-sm font-bold text-primary-400 uppercase tracking-wider mb-4 border-b border-canvas-700/50 pb-2">
                    Stock y Valoración</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="space-y-2">
                        <label for="cantidad" class="block text-sm font-medium text-canvas-300">Cantidad Inicial</label>
                        <input type="number" id="cantidad" name="cantidad"
                            class="form-input focus:border-primary-500 focus:ring-primary-500" placeholder="0" required>
                    </div>
                    <div class="space-y-2">
                        <label for="cantidad_minima" class="block text-sm font-medium text-canvas-300">Stock
                            Mínimo</label>
                        <input type="number" id="cantidad_minima" name="cantidad_minima"
                            class="form-input focus:border-primary-500 focus:ring-primary-500"
                            placeholder="Alerta en..." required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="precio" class="block text-sm font-medium text-canvas-300">Precio Unitario</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-canvas-500">€</span>
                            <input type="number" id="precio" name="precio" step="0.01"
                                class="form-input pl-8 focus:border-primary-500 focus:ring-primary-500"
                                placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label for="num_referencia" class="block text-sm font-medium text-canvas-300">Número de
                            Referencia</label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-2.5 text-canvas-500 text-[20px]">qr_code_2</span>
                            <input autocomplete="off" type="text" id="num_referencia" name="num_referencia"
                                class="form-input pl-10 focus:border-primary-500 focus:ring-primary-500"
                                placeholder="REF-0000" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-4">
                <button
                    class="w-full btn-elegant btn-primary justify-center text-lg bg-primary-600 hover:bg-primary-500 shadow-primary-500/20"
                    type="submit">
                    <span class="material-symbols-outlined mr-2">save</span> Agregar Producto
                </button>
            </div>
        </form>
    </div>
</main>
{% endblock %}

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const proveedorSelect = document.getElementById('proveedor');
        const tiposProductoSelect = document.getElementById('tipo_producto');
        const cifInput = document.getElementById('cif');

        proveedorSelect.addEventListener('change', function () {
            const proveedorId = this.value;
            fetch(`/tipos-producto/${proveedorId}`)
                .then(response => response.json())
                .then(data => {
                    tiposProductoSelect.innerHTML = '';
                    if (data.tipos_producto) {
                        data.tipos_producto.forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo;
                            option.textContent = tipo;
                            tiposProductoSelect.appendChild(option);
                        });
                    }
                });
            fetch(`/proveedor/${proveedorId}`)
                .then(response => response.json())
                .then(data => {
                    cifInput.value = data.cif || '';
                });
        });
    });
</script>
<script>
    document.getElementById("proveedor").addEventListener("change", function () {
        document.getElementById("marca").innerHTML = '<option value="" disabled selected>Seleccione la Marca</option>';
        document.getElementById("modelo").innerHTML = '<option value="" disabled selected>Seleccione el Modelo</option>';
    });
</script>
<script>
    document.getElementById('tipo_producto').addEventListener('change', function () {
        var tipoProducto = this.options[this.selectedIndex].text;
        fetch(`/get_marcas?tipo_producto=${encodeURIComponent(tipoProducto)}`)
            .then(response => response.json())
            .then(data => {
                var marcaSelect = document.getElementById('marca');
                marcaSelect.innerHTML = '';
                var defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.text = 'Seleccionar Marca';
                marcaSelect.appendChild(defaultOption);
                data.forEach(function (marca) {
                    var option = document.createElement('option');
                    option.value = marca.nombre;
                    option.text = marca.nombre;
                    marcaSelect.appendChild(option);
                });
            });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tipoProductoSelect = document.getElementById('tipo_producto');
        const marcaSelect = document.getElementById('marca');
        const modeloSelect = document.getElementById('modelo');
        marcaSelect.addEventListener('change', function () {
            // Updated script logic to handle potential empty selections robustly
            const tipoProducto = tipoProductoSelect.value.trim();
            const marca = this.value.trim();
            modeloSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Seleccionar Modelo';
            modeloSelect.appendChild(defaultOption);

            if (!tipoProducto || !marca) return;

            fetch(`/get_modelos?tipo_producto=${encodeURIComponent(tipoProducto)}&marca=${encodeURIComponent(marca)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Suppress alert for better UX or use toast, but kept simple here
                        console.warn(data.error);
                        return;
                    }
                    data.forEach(function (modelo) {
                        const option = document.createElement('option');
                        option.value = modelo.modelo;
                        option.text = modelo.modelo;
                        modeloSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    });
</script>
{% endblock %}