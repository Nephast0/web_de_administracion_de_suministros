{% extends "base.html" %}

{% block title %}Nuevo Asiento{% endblock %}

{% block body_class %}menu-body{% endblock %}

{% block content %}
<div class="glass-container">
    <h2 class="text-center mb-4" style="color: #fff;">Nuevo Asiento Manual</h2>

    <div class="d-flex justify-content-between mb-3">
        <a href="{{ url_for('contabilidad.diario') }}" class="back-btn">
            <i class="fas fa-arrow-left"></i> Volver al Diario
        </a>
    </div>

    <form method="POST" action="{{ url_for('contabilidad.nuevo_asiento') }}">
        {{ form.hidden_tag() }}

        <div class="row mb-3">
            <div class="col-md-8">
                <div class="form-group">
                    {{ form.descripcion.label(class="form-label text-white") }}
                    {{ form.descripcion(class="form-control", placeholder="Descripción del asiento") }}
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    {{ form.fecha.label(class="form-label text-white") }}
                    {{ form.fecha(class="form-control", type="date") }}
                </div>
            </div>
        </div>

        <h4 class="text-white mt-4 mb-3">Apuntes</h4>
        <div class="table-responsive">
            <table class="glass-table table table-borderless text-white" id="apuntes-table">
                <thead>
                    <tr>
                        <th>Cuenta</th>
                        <th>Debe</th>
                        <th>Haber</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="apuntes-body">
                    {% for apunte in form.apuntes %}
                    <tr class="apunte-row">
                        <td>
                            {{ apunte.cuenta_codigo(class="form-control", list="cuentas-list", placeholder="Código") }}
                        </td>
                        <td>
                            {{ apunte.debe(class="form-control text-end", step="0.01") }}
                        </td>
                        <td>
                            {{ apunte.haber(class="form-control text-end", step="0.01") }}
                        </td>
                        <td>
                            <!-- Placeholder for delete button if needed -->
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-secondary" id="add-row-btn">
                <i class="fas fa-plus"></i> Añadir Línea
            </button>
            {{ form.submit(class="cta") }}
        </div>
    </form>

    <datalist id="cuentas-list">
        {% for cuenta in cuentas %}
        <option value="{{ cuenta.codigo }}">{{ cuenta.codigo }} - {{ cuenta.nombre }}</option>
        {% endfor %}
    </datalist>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addBtn = document.getElementById('add-row-btn');
        const tbody = document.getElementById('apuntes-body');

        addBtn.addEventListener('click', function () {
            const rows = tbody.querySelectorAll('.apunte-row');
            const lastRow = rows[rows.length - 1];
            const newRow = lastRow.cloneNode(true);

            // Update indices
            const newIndex = rows.length;
            const inputs = newRow.querySelectorAll('input');

            inputs.forEach(input => {
                // Update name: apuntes-0-cuenta_codigo -> apuntes-1-cuenta_codigo
                const name = input.getAttribute('name');
                if (name) {
                    const newName = name.replace(/apuntes-\d+-/, `apuntes-${newIndex}-`);
                    input.setAttribute('name', newName);
                    input.setAttribute('id', newName);
                }
                // Clear value
                input.value = '';
                if (input.type === 'number') input.value = '0.00';
            });

            tbody.appendChild(newRow);
        });
    });
</script>
{% endblock %}