{% extends "base.html" %}
{% block title %}Gráficas de cliente{% endblock %}

{% block content %}
<main class="container mx-auto my-6 px-4 pb-12">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-8">
        <a href="{{ url_for('inventario.menu_cliente') }}"
            class="flex items-center justify-center w-10 h-10 rounded-full border border-canvas-700 text-canvas-400 hover:text-primary-400 hover:border-primary-400 transition-all bg-canvas-900/50"
            aria-label="Volver al menú del cliente">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <h1
            class="text-3xl font-bold font-heading italic text-transparent bg-clip-text bg-gradient-to-r from-canvas-100 to-canvas-400">
            Tus Métricas
        </h1>
    </div>

    <!-- Controls -->
    <div class="glass-panel p-6 mb-8 flex flex-col md:flex-row items-center justify-center gap-4">
        <label for="intervaloCliente" class="text-canvas-300 font-medium">Intervalo para historial de compras:</label>
        <div class="relative w-full md:w-64">
            <select id="intervaloCliente" class="form-input appearance-none">
                <option value="dia">Diario</option>
                <option value="semana">Semanal</option>
                <option value="mes" selected>Mensual</option>
                <option value="trimestre">Trimestral</option>
                <option value="anio">Anual</option>
            </select>
            <span
                class="material-symbols-outlined absolute right-3 top-2.5 text-canvas-500 pointer-events-none">expand_more</span>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Spend Over Time -->
        <div class="glass-panel p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-canvas-200">Gasto en el tiempo</h3>
                <a id="exportCompras" href="#"
                    class="text-primary-400 hover:text-primary-300 text-sm flex items-center gap-1 transition-colors"
                    download>
                    <span class="material-symbols-outlined text-base">download</span> Exportar
                </a>
            </div>
            <div class="relative h-64 w-full">
                <canvas id="comprasEnTiempo"></canvas>
            </div>
        </div>

        <!-- Favorite Products -->
        <div class="glass-panel p-6 animate-fade-in" style="animation-delay: 100ms">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-canvas-200">Productos preferidos</h3>
                <a href="{{ url_for('reportes.chart_export_cliente', chart_name='cliente_productos_favoritos') }}"
                    class="text-primary-400 hover:text-primary-300 text-sm flex items-center gap-1 transition-colors"
                    download>
                    <span class="material-symbols-outlined text-base">download</span> Exportar
                </a>
            </div>
            <div class="relative h-64 w-full">
                <canvas id="productosFavoritos"></canvas>
            </div>
        </div>

        <!-- Order Status -->
        <div class="glass-panel p-6 animate-fade-in lg:col-span-2" style="animation-delay: 200ms">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-canvas-200">Estado de tus pedidos</h3>
                <a href="{{ url_for('reportes.chart_export_cliente', chart_name='cliente_estados_pedido') }}"
                    class="text-primary-400 hover:text-primary-300 text-sm flex items-center gap-1 transition-colors"
                    download>
                    <span class="material-symbols-outlined text-base">download</span> Exportar
                </a>
            </div>
            <div class="relative h-64 w-full flex justify-center">
                <div class="w-full md:w-1/2 h-full">
                    <canvas id="estadoPedidos"></canvas>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function fetchJSON(url) {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Error HTTP ${response.status}`);
        }
        return response.json();
    }

    // Theme Colors
    const getThemeColor = (variable) => getComputedStyle(document.documentElement).getPropertyValue(variable).trim();

    // Fallback colors if JS executes before styles are fully computed or in some contexts
    const themeColors = {
        primary: getThemeColor('--color-primary-500') || '#14b8a6',
        primaryTransparent: (getThemeColor('--color-primary-500') || '#14b8a6') + '33',
        secondary: '#f59e0b', // Amber 500
        danger: '#ef4444', // Red 500
        success: '#10b981', // Emerald 500
        text: getThemeColor('--color-canvas-400') || '#94a3b8',
        grid: getThemeColor('--color-canvas-700') || '#334155'
    };

    Chart.defaults.color = themeColors.text;
    Chart.defaults.borderColor = themeColors.grid;

    function baseChartConfig(labels, data, label, type = 'bar') {
        const isDoughnut = type === 'doughnut';

        let backgroundColors = themeColors.primaryTransparent;
        let borderColors = themeColors.primary;

        if (isDoughnut) {
            backgroundColors = [
                themeColors.primary + '99', // 60% approx
                'rgba(245, 158, 11, 0.6)',  // Amber
                'rgba(239, 68, 68, 0.6)',   // Red
                'rgba(16, 185, 129, 0.6)',  // Emerald
                'rgba(147, 51, 234, 0.6)'   // Purple
            ];
            borderColors = [
                themeColors.primary,
                '#f59e0b',
                '#ef4444',
                '#10b981',
                '#9333ea'
            ];
        }

        return {
            type,
            data: {
                labels,
                datasets: [{
                    label,
                    data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    tension: 0.4, // Smooth curves for line charts
                    fill: type === 'line' // Fill area under line
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#e2e8f0' // Slate 200
                        }
                    }
                },
                scales: !isDoughnut ? {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(51, 65, 85, 0.3)' // Subtle grid lines
                        },
                        ticks: { color: themeColors.text }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: { color: themeColors.text }
                    }
                } : {}
            }
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        const intervalo = document.getElementById('intervaloCliente');
        const comprasCtx = document.getElementById('comprasEnTiempo');
        const favoritosCtx = document.getElementById('productosFavoritos');
        const estadosCtx = document.getElementById('estadoPedidos');
        const exportComprasBtn = document.getElementById('exportCompras');

        let comprasChart;
        let favoritosChart;
        let estadosChart;

        async function renderCompras() {
            try {
                const data = await fetchJSON(`/data/cliente/compras_tiempo?interval=${intervalo.value}`);
                if (comprasChart) comprasChart.destroy();
                comprasChart = new Chart(
                    comprasCtx,
                    baseChartConfig(
                        data.periodos,
                        data.totales,
                        `Gasto por ${data.period_label}`,
                        'line'
                    )
                );
                // Update export link
                exportComprasBtn.href = `/data/chart_export_cliente/cliente_compras_tiempo?interval=${intervalo.value}`;
            } catch (e) {
                console.error("Failed to render compras chart", e);
            }
        }

        async function renderFavoritos() {
            try {
                const data = await fetchJSON('/data/cliente/productos_favoritos');
                if (favoritosChart) favoritosChart.destroy();
                favoritosChart = new Chart(
                    favoritosCtx,
                    baseChartConfig(
                        data.productos,
                        data.cantidades,
                        'Unidades compradas',
                        'bar'
                    )
                );
            } catch (e) {
                console.error("Failed to render favoritos chart", e);
            }
        }

        async function renderEstados() {
            try {
                const data = await fetchJSON('/data/cliente/estados_pedido');
                if (estadosChart) estadosChart.destroy();
                estadosChart = new Chart(
                    estadosCtx,
                    baseChartConfig(
                        data.estados,
                        data.totales,
                        'Pedidos por estado',
                        'doughnut'
                    )
                );
            } catch (e) {
                console.error("Failed to render estados chart", e);
            }
        }

        intervalo.addEventListener('change', renderCompras);
        renderCompras();
        renderFavoritos();
        renderEstados();
    });
</script>
{% endblock %}