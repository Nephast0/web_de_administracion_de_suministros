{% extends "base.html" %}
{% block title %}Productos (Admin){% endblock %}

{% block content %}
<main class="container mx-auto my-6 px-4 pb-12">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('inventario.menu_principal') }}"
                class="flex items-center justify-center w-10 h-10 rounded-full border border-canvas-700 text-canvas-400 hover:text-primary-400 hover:border-primary-400 transition-all bg-canvas-900/50"
                aria-label="Volver al menú">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <h1
                class="text-3xl font-bold font-heading italic text-transparent bg-clip-text bg-gradient-to-r from-primary-200 to-primary-400">
                Gestión de Inventario
            </h1>
        </div>
        <a href="/agregar-producto"
            class="btn-elegant btn-primary flex items-center gap-2 text-decoration-none bg-primary-600 hover:bg-primary-500 text-white border-none shadow-lg shadow-primary-500/20">
            <span class="material-symbols-outlined">add_circle</span>
            Agregar Producto
        </a>
    </div>

    <!-- Filters -->
    <div class="glass-panel p-6 mb-8 animate-fade-in shadow-xl shadow-canvas-900/5">
        <form method="get" class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
            <!-- Search -->
            <div class="md:col-span-3 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Buscar</label>
                <div class="relative">
                    <input type="text" name="q" class="form-input pl-10 focus:border-primary-500 focus:ring-primary-500"
                        placeholder="Modelo / Referencia..." value="{{ filtros.q }}">
                    <span class="material-symbols-outlined absolute left-3 top-2.5 text-canvas-500">search</span>
                </div>
            </div>

            <!-- Basic Filters -->
            <div class="md:col-span-2 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Tipo</label>
                <input type="text" name="tipo" class="form-input focus:border-primary-500 focus:ring-primary-500"
                    value="{{ filtros.tipo }}">
            </div>
            <div class="md:col-span-2 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Marca</label>
                <input type="text" name="marca" class="form-input focus:border-primary-500 focus:ring-primary-500"
                    value="{{ filtros.marca }}">
            </div>

            <!-- Provider Filter -->
            <div class="md:col-span-3 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Proveedor</label>
                <div class="relative">
                    <select name="proveedor"
                        class="form-input appearance-none focus:border-primary-500 focus:ring-primary-500">
                        <option value="">Todos los proveedores</option>
                        {% for prov in proveedores %}
                        <option value="{{ prov.id }}" {% if filtros.proveedor==prov.id %}selected{% endif %}>{{
                            prov.nombre }}</option>
                        {% endfor %}
                    </select>
                    <span
                        class="material-symbols-outlined absolute right-3 top-2.5 text-canvas-500 pointer-events-none">expand_more</span>
                </div>
            </div>

            <!-- Stock Filter -->
            <div class="md:col-span-2 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Estado Stock</label>
                <div class="relative">
                    <select name="stock"
                        class="form-input appearance-none focus:border-primary-500 focus:ring-primary-500">
                        {% set s = filtros.stock %}
                        <option value="todos" {% if s=='todos' %}selected{% endif %}>Todos</option>
                        <option value="disponible" {% if s=='disponible' %}selected{% endif %}>Disponible</option>
                        <option value="bajo" {% if s=='bajo' %}selected{% endif %}>Stock Bajo</option>
                        <option value="sin" {% if s=='sin' %}selected{% endif %}>Agotado</option>
                    </select>
                    <span
                        class="material-symbols-outlined absolute right-3 top-2.5 text-canvas-500 pointer-events-none">expand_more</span>
                </div>
            </div>

            <!-- Advanced Filters (Second Row) -->
            <div class="md:col-span-3 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Precio Mín (€)</label>
                <input type="number" step="0.01" name="precio_min"
                    class="form-input focus:border-primary-500 focus:ring-primary-500" value="{{ filtros.precio_min }}">
            </div>
            <div class="md:col-span-3 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Precio Máx (€)</label>
                <input type="number" step="0.01" name="precio_max"
                    class="form-input focus:border-primary-500 focus:ring-primary-500" value="{{ filtros.precio_max }}">
            </div>

            <div class="md:col-span-3 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Ordenar por</label>
                <div class="relative">
                    <select name="orden"
                        class="form-input appearance-none focus:border-primary-500 focus:ring-primary-500">
                        <option value="asc" {% if orden=='asc' %}selected{% endif %}>Nombre (A-Z)</option>
                        <option value="desc" {% if orden=='desc' %}selected{% endif %}>Nombre (Z-A)</option>
                        <option value="precio_asc" {% if orden=='precio_asc' %}selected{% endif %}>Precio (Menor a
                            Mayor)</option>
                        <option value="precio_desc" {% if orden=='precio_desc' %}selected{% endif %}>Precio (Mayor a
                            Menor)</option>
                        <option value="cantidad_asc" {% if orden=='cantidad_asc' %}selected{% endif %}>Stock (Menor a
                            Mayor)</option>
                        <option value="cantidad_desc" {% if orden=='cantidad_desc' %}selected{% endif %}>Stock (Mayor a
                            Menor)</option>
                    </select>
                    <span
                        class="material-symbols-outlined absolute right-3 top-2.5 text-canvas-500 pointer-events-none">sort</span>
                </div>
            </div>

            <div class="md:col-span-3">
                <button
                    class="btn-elegant btn-primary w-full justify-center bg-primary-600 hover:bg-primary-500 text-white"
                    type="submit">
                    <span class="material-symbols-outlined mr-2">filter_alt</span> Aplicar Filtros
                </button>
            </div>
        </form>
    </div>

    <!-- Alerts -->
    {% if alertas %}
    <div
        class="glass-panel bg-amber-900/20 border-amber-500/30 p-4 mb-8 flex items-start gap-3 animate-fade-in shadow-lg shadow-amber-900/5">
        <span class="material-symbols-outlined text-amber-400">warning</span>
        <div>
            <h4 class="text-amber-200 font-bold mb-2">Atención Requerida (Stock Bajo):</h4>
            <ul class="list-disc list-inside text-amber-100/80 text-sm space-y-1">
                {% for producto in alertas %}
                <li>
                    <strong>{{ producto.tipo_producto }} {{ producto.marca }} {{ producto.modelo }}</strong>
                    - Quedan solo {{ producto.cantidad }} unidades
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Table -->
    <div class="glass-panel p-1 overflow-hidden animate-fade-in shadow-xl shadow-canvas-900/5"
        style="animation-delay: 100ms">
        <div class="overflow-x-auto rounded-lg">
            <table class="glass-table w-full text-sm text-left text-canvas-300">
                <thead class="text-xs text-canvas-400 uppercase bg-canvas-900/80 font-heading tracking-wider">
                    <tr>
                        <th class="px-6 py-4 font-semibold">Tipo</th>
                        <th class="px-6 py-4 font-semibold">Marca</th>
                        <th class="px-6 py-4 font-semibold">Modelo</th>
                        <th class="px-6 py-4 font-semibold">Descripción</th>
                        <th class="px-6 py-4 font-semibold text-right">Precio</th>
                        <th class="px-6 py-4 font-semibold text-center">Stock</th>
                        <th class="px-6 py-4 font-semibold text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-canvas-700/50">
                    {% for producto in productos %}
                    <tr class="hover:bg-primary-500/5 transition-colors group">
                        <td class="px-6 py-4">{{ producto.tipo_producto }}</td>
                        <td class="px-6 py-4 font-medium text-canvas-200">{{ producto.marca }}</td>
                        <td class="px-6 py-4 font-bold text-canvas-100">{{ producto.modelo }}</td>
                        <td class="px-6 py-4 text-canvas-400 truncate max-w-xs">{{ producto.descripcion }}</td>
                        <td class="px-6 py-4 text-right font-mono text-emerald-400 font-bold">
                            {{ producto.precio | currency }}
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if producto.cantidad == 0 %}
                            <span
                                class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs border border-red-500/30">Agotado</span>
                            {% elif producto.cantidad < 5 %} <span
                                class="bg-amber-500/20 text-amber-400 px-2 py-1 rounded text-xs border border-amber-500/30">
                                {{ producto.cantidad }}</span>
                                {% else %}
                                <span
                                    class="bg-canvas-700 text-canvas-300 px-2 py-1 rounded text-xs border border-canvas-600">{{
                                    producto.cantidad }}</span>
                                {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center gap-2">
                                <a href="{{ url_for('proveedores.editar_producto', id=producto.id) }}"
                                    class="p-2 rounded hover:bg-canvas-700 text-canvas-400 hover:text-primary-400 transition-colors"
                                    title="Editar">
                                    <span class="material-symbols-outlined text-base">edit</span>
                                </a>
                                <form action="{{ url_for('proveedores.eliminar_producto', id=producto.id) }}"
                                    method="post"
                                    onsubmit="return confirm('¿Está seguro de eliminar este producto? Esta acción no se puede deshacer.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit"
                                        class="p-2 rounded hover:bg-red-900/30 text-canvas-400 hover:text-red-400 transition-colors"
                                        title="Eliminar">
                                        <span class="material-symbols-outlined text-base">delete</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-canvas-500">
                            <span class="material-symbols-outlined text-4xl mb-2 opacity-30">search_off</span>
                            <p>No se encontraron productos.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer / Pagination -->
    <div class="flex flex-col md:flex-row justify-between items-center mt-6 gap-4">
        <div class="flex items-center gap-4">
            <span class="text-sm text-canvas-500">
                Página <span class="font-medium text-canvas-300">{{ pagination.page }}</span> de <span
                    class="font-medium text-canvas-300">{{ pagination.pages }}</span>
            </span>
            <div class="flex gap-2">
                {% if pagination.has_prev %}
                <a class="btn-elegant btn-secondary py-1 px-3 text-xs flex items-center gap-1 text-decoration-none hover:bg-canvas-700 hover:text-white"
                    href="{{ url_for('inventario.productos', page=pagination.prev_num, **filtros) }}">
                    <span class="material-symbols-outlined text-sm">arrow_back</span> Prev
                </a>
                {% endif %}

                {% if pagination.has_next %}
                <a class="btn-elegant btn-secondary py-1 px-3 text-xs flex items-center gap-1 text-decoration-none hover:bg-canvas-700 hover:text-white"
                    href="{{ url_for('inventario.productos', page=pagination.next_num, **filtros) }}">
                    Next <span class="material-symbols-outlined text-sm">arrow_forward</span>
                </a>
                {% endif %}
            </div>
        </div>

        <a class="btn-elegant btn-secondary flex items-center gap-2 text-decoration-none hover:bg-primary-900/30 hover:text-primary-300 border-canvas-600"
            href="{{ url_for('inventario.exportar_productos', **filtros) }}">
            <span class="material-symbols-outlined">download</span> Exportar CSV
        </a>
    </div>
</main>
{% endblock %}