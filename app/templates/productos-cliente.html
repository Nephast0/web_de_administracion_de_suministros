{% extends "base.html" %}
{% block title %}Productos{% endblock %}

{% block content %}
<main class="container mx-auto my-6 px-4 pb-12">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-8">
        <a href="{{ url_for('inventario.menu_cliente') }}"
            class="flex items-center justify-center w-10 h-10 rounded-full border border-canvas-700 text-canvas-400 hover:text-primary-400 hover:border-primary-400 transition-all bg-canvas-900/50"
            aria-label="Volver al menú del cliente">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <h1
            class="text-3xl font-bold font-heading italic text-transparent bg-clip-text bg-gradient-to-r from-canvas-100 to-canvas-400">
            Catálogo de Productos
        </h1>
    </div>

    <!-- Filters -->
    <div class="glass-panel p-6 mb-8 animate-fade-in">
        <form method="get" class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
            <div class="md:col-span-4 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Buscar</label>
                <div class="relative">
                    <input type="text" name="q" class="form-input pl-10" placeholder="Modelo / Referencia..."
                        value="{{ filtros.q }}">
                    <span class="material-symbols-outlined absolute left-3 top-2.5 text-canvas-500">search</span>
                </div>
            </div>
            <div class="md:col-span-2 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Tipo</label>
                <input type="text" name="tipo" class="form-input" placeholder="Ej. Portátil..."
                    value="{{ filtros.tipo }}">
            </div>
            <div class="md:col-span-2 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Marca</label>
                <input type="text" name="marca" class="form-input" placeholder="Ej. Dell..."
                    value="{{ filtros.marca }}">
            </div>
            <div class="md:col-span-2 space-y-2">
                <label class="block text-sm font-medium text-canvas-400">Disponibilidad</label>
                <div class="relative">
                    {% set s = filtros.stock %}
                    <select name="stock" class="form-input appearance-none">
                        <option value="todos" {% if s=='todos' %}selected{% endif %}>Todos</option>
                        <option value="disponible" {% if s=='disponible' %}selected{% endif %}>En Stock</option>
                        <option value="bajo" {% if s=='bajo' %}selected{% endif %}>Stock Bajo</option>
                        <option value="sin" {% if s=='sin' %}selected{% endif %}>Agotado</option>
                    </select>
                    <span
                        class="material-symbols-outlined absolute right-3 top-2.5 text-canvas-500 pointer-events-none">expand_more</span>
                </div>
            </div>
            <div class="md:col-span-2">
                <button class="btn-elegant btn-primary w-full justify-center" type="submit">
                    Aplicar Filtros
                </button>
            </div>
        </form>
    </div>

    {% if alertas %}
    <div class="glass-panel bg-amber-500/10 border-amber-500/30 p-4 mb-8 flex items-start gap-3 animate-fade-in">
        <span class="material-symbols-outlined text-amber-400">warning</span>
        <div>
            <h4 class="text-amber-200 font-bold mb-2">Productos con stock bajo:</h4>
            <ul class="list-disc list-inside text-amber-200/80 text-sm space-y-1">
                {% for producto in alertas %}
                <li>
                    <strong>{{ producto.tipo_producto }} {{ producto.marca }} {{ producto.modelo }}</strong>
                    - Quedan {{ producto.cantidad }} unidades
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Products Table -->
    <div class="glass-panel p-1 overflow-hidden animate-fade-in" style="animation-delay: 100ms">
        <div class="overflow-x-auto rounded-lg">
            <table class="w-full text-sm text-left text-canvas-300">
                <thead class="text-xs text-canvas-400 uppercase bg-canvas-900/80 font-heading tracking-wider">
                    <tr>
                        <th class="px-6 py-4 font-semibold">Tipo</th>
                        <th class="px-6 py-4 font-semibold">Marca</th>
                        <th class="px-6 py-4 font-semibold">Modelo</th>
                        <th class="px-6 py-4 font-semibold">Descripción</th>
                        <th class="px-6 py-4 font-semibold text-right">Precio</th>
                        <th class="px-6 py-4 font-semibold text-center">Stock</th>
                        <th class="px-6 py-4 font-semibold text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-canvas-700/50">
                    {% for producto in productos %}
                    <tr class="hover:bg-white/5 transition-colors group">
                        <td class="px-6 py-4">{{ producto.tipo_producto }}</td>
                        <td class="px-6 py-4 font-medium text-canvas-200">{{ producto.marca }}</td>
                        <td class="px-6 py-4 font-bold text-canvas-100">{{ producto.modelo }}</td>
                        <td class="px-6 py-4 text-canvas-400 truncate max-w-xs">{{ producto.descripcion }}</td>
                        <td class="px-6 py-4 text-right font-mono text-emerald-400 font-bold">
                            {{ producto.precio | currency }}
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if producto.cantidad == 0 %}
                            <span
                                class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs border border-red-500/30">Agotado</span>
                            {% elif producto.cantidad < 5 %} <span
                                class="bg-amber-500/20 text-amber-400 px-2 py-1 rounded text-xs border border-amber-500/30">
                                {{ producto.cantidad }}</span>
                                {% else %}
                                <span
                                    class="bg-canvas-700 text-canvas-300 px-2 py-1 rounded text-xs border border-canvas-600">{{
                                    producto.cantidad }}</span>
                                {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if producto.cantidad > 0 %}
                            <form class="flex items-center justify-center gap-2"
                                action="{{ url_for('inventario.agregar_a_la_cesta', producto_id=producto.id) }}"
                                method="post">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="number" name="cantidad" value="1" min="1" max="{{ producto.cantidad }}"
                                    class="form-input w-16 text-center text-xs py-1 h-8"
                                    aria-label="Cantidad para {{ producto.modelo }}">
                                <button type="submit"
                                    class="btn-elegant btn-primary py-1 px-3 text-xs h-8 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-base">add_shopping_cart</span> Añadir
                                </button>
                            </form>
                            {% else %}
                            <button disabled
                                class="w-full text-center text-xs text-canvas-600 cursor-not-allowed uppercase tracking-wider font-bold">
                                No disponible
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-canvas-500">
                            <span class="material-symbols-outlined text-4xl mb-2 opacity-30">search_off</span>
                            <p>No se encontraron productos que coincidan con los filtros.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-6">
        <span class="text-sm text-canvas-500">
            Página <span class="font-medium text-canvas-300">{{ pagination.page }}</span> de <span
                class="font-medium text-canvas-300">{{ pagination.pages }}</span>
        </span>
        <div class="flex gap-2">
            {% if pagination.has_prev %}
            <a class="btn-elegant btn-secondary py-2 px-4 flex items-center gap-1 text-decoration-none"
                href="{{ url_for('inventario.productos_cliente', page=pagination.prev_num, **filtros) }}">
                <span class="material-symbols-outlined text-sm">arrow_back</span> Anterior
            </a>
            {% endif %}

            {% if pagination.has_next %}
            <a class="btn-elegant btn-secondary py-2 px-4 flex items-center gap-1 text-decoration-none"
                href="{{ url_for('inventario.productos_cliente', page=pagination.next_num, **filtros) }}">
                Siguiente <span class="material-symbols-outlined text-sm">arrow_forward</span>
            </a>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}